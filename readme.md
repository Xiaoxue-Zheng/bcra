# BCRA - Breast Cancer Risk Assesment in Young Women

## Build Prerequisites
NB: It is recommended to use nvm for installing (and switching between) node versions

Below is a list of software we use in the running of the BCRA application.
The versions listed by each of them is recommended for successful building.
- node.js (10.16.3)
- PostGreSQL (13.1.0)

## Quality Assurance / Current Project Status
NB: This section is to be updated with every change that is made.

- Currently, we are awaiting an executable that is compatible with Mac and Linux operating systems. Because of this, two integration tests will fail on these platforms. These are runTyrerCuzickExecutable and readTyrerCuzickOutput. Before running the integration tests on these platforms, be sure to comment out these tests.
- Some tests make use of cy.url() to test that the page has not navigated away. Whilst this works fine, it is not the prettiest of solutions and so CLIN-1228 has been created to remedy this.

## Database

### Configure Postgres for Local Development
Install postgres on your machine, check it is running, and create the database and user with the following commands:
```
psql -U postgres
create user bcra with encrypted password 'bcra123';

create database bcra;
grant all privileges on database bcra to bcra;

create database bcratest;
grant all privileges on database bcratest to bcra;
```

### Clearing the Database
```
psql -U postgres
drop database bcra;
create database bcra;
grant all privileges on database bcra to bcra;

drop database bcratest;
create database bcratest;
grant all privileges on database bcratest to bcra;
\q
```

### Recreate Database
 * Clear the database (see above)
 * Copy .yo-rc.json and database-model.jdl to a new folder
 * `jhipster`
 * `jhipster import-jdl database-model.jdl`
 * copy to project: `/src/main/resources/config/liquibase/`

### Create Liquibase Changeset for Hibernate Changeset
 * Clear database
 * `mvnw` (creates liquibase DB)
 * Make hibernate changes
 * `mvnw compile`
 * `mvnw liquibase:diff`
 
 
## Application

The **application** project contains the back-end server, and the interface for all users except participants. It is generated by JHipster.

### Launch Local Build
Install packages: `npm install`

Build & run back-end: `mvnw`

Launch front-end: `npm start`

### Run Back-End Tests
`mvnw verify`

#### Run a Single Back-End Tests
`mvnw surefire:test -Dtest=ClassNameOfTest`

#### Run all Back-End Tests in a Package
`mvnw surefire:test -Dtest="uk.ac.herc.bcra.algorithm.**"`

### Run Front-End Tests
`npm test`

### Run Front-End E2E Tests
Navigate to the /application in two console windows.

In one window run `npm test`

In the other window run `npm run e2e`

### Build for Production
`mvnw -Pprod,war clean verify`

### Add New Entity to Model
`jhipster entity Question`

### Access Local File System Access

Make sure the application have write access to the following directory:
For Mac: /usr/local/share
For Windows and Linux: /home
This directory will be used to store Tyrercuzick process files(/tyrercuzick) and CanRiskReport files(/canrisk)

### Tyrercuzick process

#### Manual testing

##### Testing the TC process

The tyrercuzick process can be manually tested from the admin dashboard of the web application. To carry this out, follow these steps:

1. Run the backend application.
2. Run the questionnaire application.
3. Log into the backend application.
4. Select entities > Study IDs from the navigation bar.
5. Select "create new study ids".
6. Enter a comma separated list of study ids (take note of these).
    - i.e. TST_01, TST_02, TST_03, etc.
7. Head to the questionnaire application.
8. Register with one of the created study ids.
9. Complete all questionnaires.
10. Log back into the backend application.
11. Select Tyrer Cuzick Test from the navigation bar.
12. Select the "Trigger TC Process" button.
13. Open the database using the psql console.
14. Check the risk_assessment_response table for the new record.

##### Running a TC extract

We can run an extract of our TC data from the admin dashboard of the web application. This is carried out from the same page as the TC process test.

This requires some setup that will be done in the setup phase of the server. If this is the first time you have ran the software on your local machine, you will have to do this.

To run this process:
1. Run the backend application.
2. Run the questionnaire application.
3. Log into the backend application.
4. Head to the Tyrer Cuzick Test page from the navigation bar.
5. Select the "Trigger TC Extract Test" button.
6. This should create an extract file in the tyrercuzick directory under a subdirectory titled /extract/.
 
## Questionnaire

The **questionniare** project contains the front-end for participants. It is generated by vue-cli.

### Logging in for development/testing/inspecting
If you want to login to the questionnaire interface:
1. Open the Admin Interface (localhost:8080) and import **Participant1111111111.csv**
2. Open the Participant Interface (localhost:3210) and register as this participant (NHS number: 1111111111 and DOB 11/11/1111)
3. Sign in with the chosen username/password


### Launch Local Build
Install packages: `npm install`

Launch front-end: `npm run serve`

### Build for Production

Build front-end: `npm run build -Pprod`

<del>This will place a **.war** file in the **dist** folder.</del>

(The warfile plugin is temporarily deactivated, because it conflicts with Cypress end-to-end tests.

### Run Tests

#### Unit Tests
`npm run test:unit`

#### End-to-End Tests
1. Clear the database (see above) if there have been any model changes.
2. Launch back-end with `mvnw` from the /application directory
3. Run `npm run test:e2e` from the /questionnaire directory

To run end-to-end tests in a headless environment, use: `npm run test:headless`

#### Test StudyId
A default study ID is created to test the new sign up functionality. 
This id is 'TST_1', and has a consent and risk assessment questionnaire automatically assigned.

## Deploying on server
The following instructions guide you through the process of uploading both the backend and front-end to a server.

Build and package the server backend and admin console:
`cd <PROJECT_DIR>/application`
`mvnw -Pprod,war clean verify`

Build and package the front end: 
`cd <PROJECT_DIR>/questionnaire`
`npm run build -Pprod`
`mv dist hryws`
Zip in Windows: `tar.exe -a -c -f hryws.zip hryws`
Zip in Mac and Linux: `zip hryws.zip hryws` 

Copy the generated files to the server of choice.

Place both the zip files into the tomcat webapps folder.
(Manually unzip the hryws.zip file)

Restart tomcat:
`service tomcat restart`

### Deploy with the script
There is a deploy script named deploy.sh can be used to deploy.
Before you deploy, you should set up password-free login with the host you will deploy the application. 
The command is ssh-copy-id USER@host, example: ssh-copy-id b75865xz@130.88.96.158

The parameter you must specify is:
-p: your project directory

The parameters you can optionaly specify are:
-q: if to deploy questionnaire application, default false
-c: if to deploy clinitian interface, default false
-v: the new version, it is used to upgrade the verion and create a release, but we now fix it as 0.0.1, after we change to GitHub, we can reconsider how to do upgrade version and create a release
-p: the profile you want to deploy, the value can be: test(will deploy to hubble.mhealthherc.com); prod(will deploy to AWS(not applied now))

The following command will deploy quesitonnaire application and clinician interface to hubble.mhealthherc.com
./deploy.sh -v=0.0.1 -d=/Users/user/ideaProjects/bcra/ -q=true -c=true -p=test